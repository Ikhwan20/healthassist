<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthAssist - Book Appointment</title>
    <link rel="stylesheet" href="css/booking.css">
    <script defer src="js/booking.js"></script>
    <script defer src="js/header.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Collect appointment and payment details
            const paymentDate = document.getElementById('preferred-date').value;
            const paymentMethod = document.getElementById('payment-method').value;
            const checkupName = document.getElementById('appointment-name').textContent; // Assuming the appointment name is set in the page
            const appointmentTime = "10:00:00"; // Default time (can be adjusted or added as an input field)

            // Retrieve card details if the payment method is Credit Card or Debit Card
            const cardNumber = paymentMethod === 'CREDIT CARD' || paymentMethod === 'DEBIT CARD' 
                ? document.getElementById('card-number').value 
                : null;
            const expiryDate = paymentMethod === 'CREDIT CARD' || paymentMethod === 'DEBIT CARD' 
                ? document.getElementById('expiry-date').value 
                : null;
            const cvv = paymentMethod === 'CREDIT CARD' || paymentMethod === 'DEBIT CARD' 
                ? document.getElementById('cvv').value 
                : null;

            // Retrieve the JWT token from localStorage
            const token = localStorage.getItem('authToken');
            if (!token) {
                return alert('Token is required. Please log in first.');
            }

            // Decode the JWT token to retrieve user ID
            const decodedToken = jwt_decode(token);
            const userId = decodedToken.user_id;

            // Prepare appointment data
            const appointmentData = {
                user_id: userId,
                appointment_date: paymentDate,
                appointment_time: appointmentTime,
                checkup_name: checkupName,
            };

            // Prepare payment data
            const paymentData = {
                user_id: userId,
                payment_date: paymentDate,
                payment_method: paymentMethod,
                card_number: cardNumber,
                expiry_date: expiryDate,
                cvv: cvv,
            };

            try {
                // Send payment data to the API
                const paymentResponse = await fetch('/api/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(paymentData),
                });

                if (!paymentResponse.ok) {
                    const error = await paymentResponse.json();
                    return alert('Failed to record payment: ' + error.error);
                }

                const paymentResult = await paymentResponse.json();
                alert('Payment successfully recorded! Payment ID: ' + paymentResult.payment_id);

                // Send appointment data to the API
                const appointmentResponse = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(appointmentData),
                });

                if (appointmentResponse.ok) {
                    const appointmentResult = await appointmentResponse.json();
                    alert('Appointment successfully created! Appointment ID: ' + appointmentResult.appointment_id);
                } else {
                    const error = await appointmentResponse.json();
                    alert('Failed to create appointment: ' + error.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing the booking.');
            }
        });

        // Show/Hide card details based on payment method
        const paymentMethodSelect = document.getElementById('payment-method');
        const cardDetails = document.getElementById('card-details');
        paymentMethodSelect.addEventListener('change', () => {
            if (paymentMethodSelect.value === 'CREDIT CARD' || paymentMethodSelect.value === 'DEBIT CARD') {
                cardDetails.style.display = 'block';
            } else {
                cardDetails.style.display = 'none';
            }
        });
    });

    </script>     
</head>
<body data-page="appointment">

    <!-- Placeholder for Header -->
    <div id="header-placeholder"></div>

    <main>
        <section hidden id="appointment-title"></section>
        <section class="intro">
            <h1>Book Appointment</h1>
        </section>
        <section class="booking-details">
            <div class="image-section">
                <div class="image">
                    <img id="appointment-image" src="" alt="Appointment Type">
                    <h2 class="book-now">BOOK NOW</h2>
                </div>
                <p class="appointment-name" id="appointment-name"></p>
                <p id="appointment-description"></p>
            </div>
            
            <div class="info-section">
                <h2>Tests Included:</h2>
                <ul id="tests-list">
                    <!-- Tests will be dynamically added here -->
                </ul>
                <h2>Importance:</h2>
                <ul id="importance-text">
                    <!-- Tests will be dynamically added here -->
                </ul>
                <h2>When You Should Schedule This Checkup:</h2>
                <ul id="appointment-schedule">
                    <!-- Tests will be dynamically added here -->
                </ul>
                <form class="booking-form">
                    <input type="hidden" id="appointment-title" value="">
                    <label for="payment-method">Payment Method:</label>
                    <select id="payment-method" name="payment-method">
                        <option value="CASH">Cash</option>
                        <option value="CREDIT CARD">Credit Card</option>
                        <option value="DEBIT CARD">Debit Card</option>
                        <option value="INSURANCE">Insurance</option>
                    </select>
                
                    <div id="card-details" style="display: none;">
                        <label for="card-number">Card Number:</label>
                        <input type="text" id="card-number" name="card-number" placeholder="Enter your card number">
                
                        <label for="expiry-date">Expiry Date:</label>
                        <input type="text" id="expiry-date" name="expiry-date" placeholder="MM/YY">
                
                        <label for="cvv">CVV:</label>
                        <input type="text" id="cvv" name="cvv" placeholder="CVV">
                    </div>
                
                    <label for="preferred-date">Preferred Date:</label>
                    <input type="date" id="preferred-date" name="preferred-date" required>
                
                    <button type="submit" class="book-now-btn">BOOK NOW</button>
                </form>
                
                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        const paymentMethodSelect = document.getElementById('payment-method');
                        const cardDetails = document.getElementById('card-details');
                
                        // Listen for changes in the payment method dropdown
                        paymentMethodSelect.addEventListener('change', () => {
                            const selectedMethod = paymentMethodSelect.value;
                
                            // Show card details if Credit Card or Debit Card is selected
                            if (selectedMethod === 'CREDIT CARD' || selectedMethod === 'DEBIT CARD') {
                                cardDetails.style.display = 'block';
                            } else {
                                cardDetails.style.display = 'none';
                            }
                        });
                    });
                </script>
                
            </div>
        </section>
    </main>
</body>
</html>
